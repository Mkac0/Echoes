{% extends "base.html" %}
{% block content %}

<div class="car-detail-container">
    <div class="car-header">
        <h2>{{ object.year }} {{ object.make }} {{ object.model }}</h2>
        <p class="vin">VIN: <strong>{{ object.vin }}</strong></p>
        {% if object.owner and object.owner.profile %}
            <p class="car-owner">
                Owner:
                <a class="profile-link" href="{% url 'profile-public' object.owner_id %}">
                    {{ object.owner.get_username }}
                </a>
            </p>
        {% endif %}
    </div>
    <div class="car-meta">
        <div class="meta-item"><span>Mileage:</span> {{ object.mileage|default:"N/A" }}</div>
        <div class="meta-item"><span>Price:</span> ${{ object.price|default:"0.00" }}</div>
        <div class="meta-item"><span>Condition:</span> {{ object.condition|default:"Used" }}</div>
        <div class="meta-item">
            <span>Status:</span> 
            <span class="status status-{{ object.status }}">{{ object.get_status_display }}</span>
        </div>
    </div>
    {% if request.user.is_authenticated %}
        {% if request.user == object.owner or request.user.is_lead %}
            <div class="action-links">
                <a href="{% url 'car-update' object.pk %}" class="btn edit-btn">Edit</a>
                <form action="{% url 'car-delete' object.pk %}" method="post" class="inline-form">
                    {% csrf_token %}
                    <button type="submit" class="btn delete-btn" onclick="return confirm('Delete this car?');">
                    Delete
                    </button>
                </form>
            </div>
        {% endif %}
    {% endif %}
    <hr class="divider"/>
    <h3>Photos ({{ object.photos.count }})</h3>
    <div class="car-photos-grid">
        {% for p in object.photos.all %}
            <figure class="photo-item">
                <img src="{{ p.image.url }}" alt="{{ p.caption|default:object.make }}">
                {% if p.caption %}<figcaption>{{ p.caption }}</figcaption>{% endif %}
                {% if request.user.is_authenticated and request.user == object.owner %}
                    <div class="photo-actions">
                        {% if request.user == object.user %}
                            <p><a href="{% url 'profile-edit' %}" class="btn btn-primary">Edit Profile</a></p>
                        {% endif %}
                        <form method="post" action="{% url 'carphoto-delete' p.pk %}" onsubmit="return confirm('Delete this photo?');">
                            {% csrf_token %}
                            <button class="btn btn-sm btn-delete" type="submit">Delete</button>
                        </form>
                    </div>
                {% endif %}
            </figure>
        {% empty %}
            <p class="meta">No photos uploaded yet.</p>
        {% endfor %}
    </div>
    {% if request.user.is_authenticated %}
        {% if request.user == object.owner or request.user.is_lead %}
            <div class="mt-4">
                <a href="{% url 'carphoto-create' object.pk %}" class="btn btn-secondary">Add Photos</a>
            </div>
        {% endif %}
    {% endif %}
</div>

{% endblock %}
